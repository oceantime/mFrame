# Copilot Instructions for mFrame

## Architecture
- Native engine lives in [core/src](core/src); [WmCanvas.cpp](core/src/WmCanvas.cpp) and [WmCanvasManager.cpp](core/src/WmCanvasManager.cpp) create canvases that dispatch to 2D ([wmcanvas](core/src/wmcanvas)) and WebGL ([webgl](core/src/webgl)) contexts.
- Platform glue sits in [core/src/platform/Android](core/src/platform/Android); it wraps EGL ([egl](core/src/platform/Android/egl)), fonts, and FBO handling ([WmFrameBufferObjectImpl.cpp](core/src/platform/Android/WmFrameBufferObjectImpl.cpp)).
- JNI bindings under [core/android](core/android) expose the C++ engine to Java, and [android/wmcanvas_library/src/main/java/com/taobao/wmcanvas](android/wmcanvas_library/src/main/java/com/taobao/wmcanvas) provides the Android API surface (texture views, helpers, bridge spec).
- Demo flows use [android/demo](android/demo) to host a WebView; it loads the AAR generated by the library and exercises the JS bridge sample in [android/demo/src/main/assets/gcanvas_demo.html](android/demo/src/main/assets/gcanvas_demo.html).
- Node bindings in [node/binding](node/binding) wrap the same core through `cmake-js`, exposing Canvas/WebGL APIs to Node runtimes (Linux-focused).

## Native Build & Flags
- Primary CMake file [core/CMakeLists.txt](core/CMakeLists.txt) configures C++14, hides symbols by default, and conditionally pulls JNI, PNG, and 3D code when `WMCANVAS=1`.
- `WMCANVAS=0` (default Android flavor) strips legacy Weex pieces, while `WMCANVAS=1` includes [core/android/manager](core/android/manager) and related bridge code for full stacks.
- `WMCANVAS_RUNTIME=1` (set by the standalone flavor) renames the shared object to `libwmcanvas_runtime.so`; keep this flag if you add new native targets so the demo continues to resolve the correct library.
- `GCANVAS_DISTRIBUTE_HEADER` enables header staging into `core/distribution`; if you introduce new public headers, add them to the copy list near the bottom of [core/CMakeLists.txt](core/CMakeLists.txt).
- Font rendering depends on the prebaked FreeType bundle in [core/android/freetype-prebuilt](core/android/freetype-prebuilt); do not remove or rename its layout without updating include and import paths.

## Android Workflow
- Only `:android:wmcanvas_library` and `:android:demo` are active in [settings.gradle](settings.gradle); add new modules explicitly if needed.
- Library builds target SDK 28 with NDK 21.1; configure `local.properties` for the Android SDK path before invoking Gradle.
- Default flavor `standalone` calls CMake with `-DANDROID_STL=c++_shared -DGSTANDALONE=1`; keep additional flags in sync if you introduce new flavors in [android/wmcanvas_library/build.gradle](android/wmcanvas_library/build.gradle).
- Publishing to the local Maven repo is driven by [publish_local.gradle](publish_local.gradle); new artifacts must set `project.ext.id` and `project.ext.meta` in their module to publish correctly.
- Demo module consumes the generated AAR via `flatDir` and depends on `assembleStandaloneDebug/Release`; ensure those tasks run before touching demo assets or Java code.

### Useful Commands
```
# Clean and build native Android library
./gradlew clean :android:wmcanvas_library:assembleStandaloneRelease

# Publish library variants to local Maven
./gradlew :android:wmcanvas_library:publishToMavenLocal

# Build Node native addon (Linux)
npm install cmake-js -g
local=true npm install
cmake-js compile
```

## Coding Patterns
- Extend Canvas features by modifying [WmCanvas2dContext.cpp](core/src/wmcanvas/WmCanvas2dContext.cpp) or [WmWebglContext.cpp](core/src/wmcanvas/WmWebglContext.cpp); update decoders in [commandbuffer](core/src/commandbuffer) so new commands flow through the bridge.
- Precompiled shaders live in [WmPreCompiledShaders.cpp](core/src/platform/Android/WmPreCompiledShaders.cpp); regenerate blobs with the same naming when adding new shader programs.
- Logging uses [support/Log.cpp](core/src/support/Log.cpp); prefer the existing macros rather than new logging systems to keep native logs consistent with Android expectations.
- Java entry points funnel through [WmCanvasJNI.java](android/wmcanvas_library/src/main/java/com/taobao/wmcanvas/WmCanvasJNI.java); when adding native methods, declare them here and implement the counterpart in [core/android/WmCanvasJNI.cpp](core/android/WmCanvasJNI.cpp).

## Testing & Debugging
- Android demo is the quickest smoke test; after building the standalone flavor, install from [android/demo/build/outputs/apk](android/demo/build/outputs/apk).
- Headless validation for Node bindings runs via `case=<example>.js npm run test` as documented in [node/README.MD](node/README.MD); examples write PNG/JPEG outputs into the repo.
- GPU issues are easiest to reproduce with the command buffer replay; capture sequences via the Java API and inspect the decoded flow inside [WmCommandDecoder.cpp](core/src/commandbuffer/WmCommandDecoder.cpp).
